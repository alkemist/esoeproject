<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="PolicyCache">

	<!-- Data object being mapped to -->
	<typeAlias alias="policyCache" type="com.qut.middleware.esoe.pdp.cache.sqlmap.impl.PolicyCacheData" />
	
	<!-- Data object used for select statements -->
	<typeAlias alias="policyCacheQuery" type="com.qut.middleware.esoe.pdp.cache.sqlmap.impl.PolicyCacheQueryData" />
	
	<!-- 
	DESCRIPTORID VARCHAR2(512) NOT NULL, LXACMLPOLICY CLOB NOT NULL, DATE_LAST_UPDATED DATE NOT NULL
	 -->
	
	<!-- - - - - Select definition - - - - -->
	
	<parameterMap id="policyCacheQueryParam" class="policyCacheQuery">
		<parameter property="dateLastUpdated" jdbcType="DATE" />
	</parameterMap>
	
	<resultMap id="policyCacheResult" class="policyCache">
		<result property="descriptorID" column="DESCRIPTORID"/>
		<result property="lxacmlPolicy" column="LXACMLPOLICY" jdbcType="CLOB"/>		
		<result property="dateLastUpdated" column="DATE_LAST_UPDATED"/>	
	</resultMap>
	
	<select id="updatedPoliciesCacheQuery" parameterMap="policyCacheQueryParam" 
			resultMap="policyCacheResult">
		SELECT DESCRIPTORID, LXACMLPOLICY, DATE_LAST_UPDATED FROM SERVICE_POLICIES
		WHERE DATE_LAST_UPDATED <![CDATA[ > ]]> ? 
		AND DESCRIPTORID in (SELECT DESCRIPTORS.DESCRIPTORID FROM DESCRIPTORS, ENTITY_DESCRIPTORS 
							 WHERE DESCRIPTORS.ENTITYID = ENTITY_DESCRIPTORS.ENTITYID
							 AND ACTIVEFLAG = 'y'
							 AND DESCRIPTORTYPEID = 2)
	</select>
			
			
	<select id="allPoliciesCacheQuery" resultMap="policyCacheResult">
		SELECT DESCRIPTORID, LXACMLPOLICY, DATE_LAST_UPDATED FROM SERVICE_POLICIES
		WHERE DESCRIPTORID in (SELECT DESCRIPTORS.DESCRIPTORID FROM DESCRIPTORS, ENTITY_DESCRIPTORS 
							 WHERE DESCRIPTORS.ENTITYID = ENTITY_DESCRIPTORS.ENTITYID
							 AND ACTIVEFLAG = 'y'
							 AND DESCRIPTORTYPEID = 2)
	</select>
	
	<!-- - - - - Get the latest update time - - - - -->
	
	<select id="policyCacheQueryLatestUpdate" resultClass="java.util.Date">
		SELECT Max(DATE_LAST_UPDATED) as value FROM SERVICE_POLICIES
	</select>
	
</sqlMap>