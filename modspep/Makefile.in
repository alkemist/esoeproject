SHELL=/bin/sh

.SUFFIXES: .cpp .o .so

VERSION=@PACKAGE_VERSION@

MODULE_VERSION=@MODULE_VERSION@

XERCESPATH=@XERCESPATH@
XMLSECPATH=@XMLSECPATH@
SAML2CPPPATH=@SAML2CPPPATH@
SPEPCPPPATH=@SPEPCPPPATH@
ICUPATH=@ICUPATH@
AXIS2PATH=@AXIS2PATH@
APACHEPATH=@APACHEPATH@
APREQPATH=@APREQPATH@

ifneq "$(XERCESPATH)" ""
XERCESLIB=-L$(XERCESPATH)/lib
XERCESINCLUDE=-I$(XERCESPATH)/include
endif

ifneq "$(XMLSECPATH)" ""
XMLSECLIB=-L$(XMLSECPATH)/lib
XMLSECINCLUDE=-I$(XMLSECPATH)/include
endif

ifneq "$(SAML2CPPPATH)" ""
SAML2CPPLIB=-L$(SAML2CPPPATH)/build
SAML2CPPINCLUDE=-I$(SAML2CPPPATH)/includes -I$(SAML2CPPPATH)/src-gen
endif

ifneq "$(SPEPCPPPATH)" ""
SPEPCPPLIB=-L$(SPEPCPPPATH)/build
SPEPCPPINCLUDE=-I$(SPEPCPPPATH)/includes
endif

ifneq "$(ICUPATH)" ""
ICULIB=-L$(ICUPATH)/lib
ICUINCLUDE=-I$(ICUPATH)/include
endif

ifneq "$(AXIS2PATH)" ""
AXIS2LIB=-L$(AXIS2PATH)/lib
AXIS2INCLUDE=-I$(AXIS2PATH)/include/axis2-1.0
endif

ifneq "$(APREQPATH)" ""
APREQLIB=-L$(APREQPATH)/lib
APREQINCLUDE=-I$(APREQPATH)/include
endif

ifneq "$(APACHEPATH)" ""
APACHELIB=-L$(APACHEPATH)/lib
APACHEINCLUDE=-I$(APACHEPATH)/include
endif

CFLAGS=@CFLAGS@
CPPFLAGS=@CPPFLAGS@
CXXFLAGS=@CXXFLAGS@
DEFS=@DEFS@
LDFLAGS=@LDFLAGS@
LIBS=@LIBS@
INCLUDES=-I@srcdir@/includes $(SPEPCPPINCLUDE) $(SAML2CPPINCLUDE) $(XERCESINCLUDE) $(XMLSECINCLUDE) $(ICUINCLUDE) $(AXIS2INCLUDE) $(APACHEINCLUDE) $(APREQINCLUDE)
LIBS=@APREQ_LIB@ -lcurl -lsaml2 -lspep -laxis2 -lboost_program_options -lboost_regex -lboost_thread -lboost_date_time -lxerces-c -lxml-security-c -licuuc -licutu -licule -liculx -licuio -licudata -licui18n $(XERCESLIB) $(XMLSECLIB) $(SAML2CPPLIB) $(SPEPCPPLIB) $(ICULIB) $(AXIS2LIB) $(APREQLIB)
APACHEFLAGS=@APACHEFLAGS@

# xx Edit here for other toolsets xx
SHLIB_CXXFLAGS=-fPIC -DPIC=1
SHLIB_LDFLAGS=-shared
MODPREFIX=mod
MODSUFFIX=.so

INSTALL=@INSTALL@
INSTALL_DATA=@INSTALL_DATA@
MKDIR_P=@MKDIR_P@

prefix=@prefix@
exec_prefix=@exec_prefix@

bindir=@bindir@
sbindir=@sbindir@
sysconfdir=@sysconfdir@
libdir=@libdir@

OUTDIR=@builddir@/build
SRCDIR=@srcdir@/src
INCDIR=@srcdir@/includes

DISTDIR=@builddir@/distribution
TARNAME=modspep-$(VERSION)
DISTFILES=configure Makefile.in install-sh AUTHORS LICENSE NOTICE README

BIN=$(OUTDIR)/$(MODPREFIX)spep$(MODSUFFIX)
OBJ= \
$(OUTDIR)/$(MODULE_VERSION).o \
$(OUTDIR)/Common.o \
$(OUTDIR)/APRFileLogger.o \
$(OUTDIR)/Cookies.o \
$(OUTDIR)/SSOHandler.o \
$(OUTDIR)/WSHandler.o \
$(OUTDIR)/Base64.o \
$(OUTDIR)/RequestParameters.o \
$(OUTDIR)/RequestHandler.o

all: prepare $(BIN)

install: all
	@echo .
	@echo "Now please copy $(BIN) to your Apache module directory and configure :)" 

dist:
	$(MKDIR_P) $(DISTDIR)/$(TARNAME)
	cp -frt $(DISTDIR)/$(TARNAME) $(SRCDIR) $(INCDIR) $(DISTFILES)
	tar zc -C $(DISTDIR) -f $(TARNAME).tar.gz --exclude .svn --no-anchored $(TARNAME)

clean:
	rm -f $(BIN) $(OBJ)

$(BIN): $(OBJ)
	$(CXX) $(LDFLAGS) $(LIBS) $(SHLIB_LDFLAGS) -o $@ $(OBJ)

prepare:
	$(MKDIR_P) $(OUTDIR)

$(OUTDIR)/$(MODULE_VERSION).o: $(SRCDIR)/versions/$(MODULE_VERSION).cpp
	$(CXX) $(CXXFLAGS) $(SHLIB_CXXFLAGS) $(APACHEFLAGS) $(INCLUDES) -c -o $@ $<

$(OUTDIR)/%.o: $(SRCDIR)/%.cpp
	$(CXX) $(CXXFLAGS) $(SHLIB_CXXFLAGS) $(APACHEFLAGS) $(INCLUDES) -c -o $@ $<

