CREATE TABLE ENTITY_DESCRIPTORS (ENTITYID VARCHAR2(512) NOT NULL, ORGANIZATIONNAME VARCHAR2(1024) NOT NULL, ORGANIZATIONDISPLAYNAME VARCHAR2(1024) NOT NULL, ORGANIZATIONURL VARCHAR2(1024) NOT NULL, ACTIVEFLAG CHAR(1) NOT NULL, DESCRIPTORID VARCHAR2(512), PRIMARY KEY (ENTITYID))
COMMENT ON TABLE ENTITY_DESCRIPTORS IS 'Stores authorative reference to all service points deployed in the system'
COMMENT ON COLUMN ENTITY_DESCRIPTORS.ENTITYID IS 'Specifies the unique identifier of the SAML entity described by this entries contents'
COMMENT ON COLUMN ENTITY_DESCRIPTORS.ORGANIZATIONNAME IS 'Language qualified names that may or may not be suitable for human consumption'
COMMENT ON COLUMN ENTITY_DESCRIPTORS.ORGANIZATIONDISPLAYNAME IS 'Language qualified names that are suitable for human consumption'
COMMENT ON COLUMN ENTITY_DESCRIPTORS.ORGANIZATIONURL IS 'Language qualified URI that specify a location to which to direct a user for additional information'
COMMENT ON COLUMN ENTITY_DESCRIPTORS.ACTIVEFLAG IS 'Denotes if this entity is currently considered active for the puposes of generating metadata and other processing inside the ESOE'

CREATE TABLE SERVICE_DESCRIPTIONS (ENTITYID VARCHAR2(512) NOT NULL, SERVICENAME VARCHAR2(1024) NOT NULL, SERVICEURL VARCHAR2(2048) NOT NULL, SERVICEDESC VARCHAR2(2048), AUTHZFAILUREMSG VARCHAR2(2048), PRIMARY KEY (ENTITYID))
COMMENT ON TABLE SERVICE_DESCRIPTIONS IS 'Stores authorative reference to all service points deployed in the system'
COMMENT ON COLUMN SERVICE_DESCRIPTIONS.SERVICENAME IS 'Name of the service'
COMMENT ON COLUMN SERVICE_DESCRIPTIONS.SERVICEURL IS 'URL that specifies the location of the service used by clients to access the service'
COMMENT ON COLUMN SERVICE_DESCRIPTIONS.SERVICEDESC IS 'Description of the service suitable for human consumption'
COMMENT ON COLUMN SERVICE_DESCRIPTIONS.AUTHZFAILUREMSG IS 'Details to be provided by central system when authorization fails'

CREATE TABLE DESCRIPTORS (ENTITYID VARCHAR2(512) NOT NULL, DESCRIPTORID VARCHAR2(512) NOT NULL, DESCRIPTORXML CLOB NOT NULL, DESCRIPTORTYPEID NUMBER(2) NOT NULL, PRIMARY KEY(DESCRIPTORID))
COMMENT ON TABLE DESCRIPTORS IS 'Stores authoritive reference to all descriptors deployed in this system for each entity.'
COMMENT ON COLUMN DESCRIPTORS.ENTITYID IS 'The entity to which this descriptor belongs to'
COMMENT ON COLUMN DESCRIPTORS.DESCRIPTORID IS 'A SAML document unique identifier, generally used as a reference point for signatures but also uniquely identifies this descriptor, generated by the SAML2lib-j IdentifierGenerator'
COMMENT ON COLUMN DESCRIPTORS.DESCRIPTORXML IS 'Contains one of the different extensions of the SAML RoleDescriptorType with content reflecting to which the RoleDescriptor belongs. This field stores an XML representation the descriptor'
COMMENT ON COLUMN DESCRIPTORS.DESCRIPTORTYPEID IS 'References the look up table DESCRIPTORTYPES'

CREATE TABLE SERVICE_ENDPOINTS (DESCRIPTORID VARCHAR2(512) NOT NULL, ENDPOINTID VARCHAR(12) NOT NULL, NODEURL VARCHAR2(512) NOT NULL, ASSERTIONCONSUMER_ENDPOINT VARCHAR2(512) NOT NULL, SINGLELOGOUT_ENDPOINT VARCHAR2(512) NOT NULL, CACHECLEAR_ENDPOINT VARCHAR2(512) NOT NULL, PRIMARY KEY (ENDPOINTID, DESCRIPTORID))
COMMENT ON TABLE SERVICE_ENDPOINTS IS 'Table which stores endpoints for each logic node of the service, this will be used to generate the service descriptor xml document to saml compliance'
COMMENT ON COLUMN SERVICE_ENDPOINTS.DESCRIPTORID IS 'References DESCRIPTORS.DESCRIPTORID. Provides a keyed look up mechanism to relate these endpoints to a service descriptor.'
COMMENT ON COLUMN SERVICE_ENDPOINTS.ENDPOINTID IS 'Unique value representing the id of each backend node for this service, this is used as the value of index when createing IndexedEndpointType'
COMMENT ON COLUMN SERVICE_ENDPOINTS.NODEURL IS 'Base URL of node which is combined with each endpoint below when generating service descriptor'
COMMENT ON COLUMN SERVICE_ENDPOINTS.ASSERTIONCONSUMER_ENDPOINT IS 'SAML Assertion consumer endpoint, will be combined with value of NodeURL for generation of service descriptor values'
COMMENT ON COLUMN SERVICE_ENDPOINTS.SINGLELOGOUT_ENDPOINT IS  'SAML single logout endpoint, will be combined with value of NodeURL for generation of service descriptor values'
COMMENT ON COLUMN SERVICE_ENDPOINTS.CACHECLEAR_ENDPOINT IS  'LXACML cache clear endpoint, will be combined with value of NodeURL for generation of service descriptor values'

CREATE TABLE DESCRIPTOR_TYPES (DESCRIPTORTYPEID NUMBER(2) NOT NULL, DESCRIPTORTYPEDESCRIPTION VARCHAR2(128) NOT NULL, PRIMARY KEY(DESCRIPTORTYPEID))
COMMENT ON TABLE DESCRIPTOR_TYPES IS 'A look up table to determine what type of RoleDescriptor is contained within the the DESCRIPTORS table.'
COMMENT ON COLUMN DESCRIPTOR_TYPES.DESCRIPTORTYPEID IS 'References DESCRIPTORS.DESCRIPTORTYPE. Provides a keyed look up mechanism.'
COMMENT ON COLUMN DESCRIPTOR_TYPES.DESCRIPTORTYPEDESCRIPTION IS 'A human readable description of the SAML type contained within the descriptors table.'
INSERT INTO DESCRIPTOR_TYPES VALUES (1, 'IDPSSODescriptor')
INSERT INTO DESCRIPTOR_TYPES VALUES (2, 'SPSSODescriptor')
INSERT INTO DESCRIPTOR_TYPES VALUES (3, 'LXACMLPDPDescriptor')
INSERT INTO DESCRIPTOR_TYPES VALUES (4, 'AuthNAuthorityDescriptor')
INSERT INTO DESCRIPTOR_TYPES VALUES (5, 'AttributeAuthorityDescriptor')

CREATE TABLE ENTITY_CONTACTS (CONTACTTYPE VARCHAR2(255) NOT NULL CHECK(CONTACTTYPE IN ('technical', 'support', 'administrative', 'billing', 'other')), ENTITYID VARCHAR2(512) NOT NULL, CONTACTID VARCHAR2(12) NOT NULL, COMPANY VARCHAR2(255), GIVENNAME VARCHAR2(255) NOT NULL, SURNAME VARCHAR2(255) NOT NULL, EMAILADDRESS VARCHAR2(255) NOT NULL, TELEPHONENUMBER VARCHAR2(255) NOT NULL, CONSTRAINT CONTACTTYPE PRIMARY KEY (CONTACTID, ENTITYID))
COMMENT ON TABLE ENTITY_CONTACTS IS 'Provides contact details for each service provider deployed within the system'
COMMENT ON COLUMN ENTITY_CONTACTS.CONTACTTYPE IS 'Specifies the type of contact'
COMMENT ON COLUMN ENTITY_CONTACTS.CONTACTID IS 'Unique numerical reference for this contact which wont change'
COMMENT ON COLUMN ENTITY_CONTACTS.COMPANY IS 'Specifies the name of the company for the contact person'
COMMENT ON COLUMN ENTITY_CONTACTS.GIVENNAME IS 'Specifies the given name of the contact person'
COMMENT ON COLUMN ENTITY_CONTACTS.SURNAME IS 'Optional string element that specifies the surname of the contact person'
COMMENT ON COLUMN ENTITY_CONTACTS.EMAILADDRESS IS 'Contains mailto: URIs representing email addresses belonging to the contact person'
COMMENT ON COLUMN ENTITY_CONTACTS.TELEPHONENUMBER IS 'Specifies a telephone number of the contact person'

CREATE TABLE CLIENT_SESSIONS (SESSIONID VARCHAR2(255) NOT NULL, DESCRIPTORID VARCHAR2(512) NOT NULL, ENDPOINT VARCHAR2(255) NOT NULL, USERIDENTIFIER VARCHAR2(255) NOT NULL, DATESTART DATE NOT NULL, AUTHNMETHOD VARCHAR2(255) NOT NULL, IPV4ADDRESS VARCHAR2(32) NOT NULL, IPV6ADDRESS VARCHAR2(128), DATESTOP DATE, PRIMARY KEY (SESSIONID))
COMMENT ON TABLE CLIENT_SESSIONS IS 'Stores authorative reference for all sessions which were successfully authenticated on the system'
COMMENT ON COLUMN CLIENT_SESSIONS.SESSIONID IS 'Unique identifier for the authenticated session. Must remain unique for all time.'
COMMENT ON COLUMN CLIENT_SESSIONS.DESCRIPTORID IS 'The Descriptor ID of the SAML endpoint the session was established to'
COMMENT ON COLUMN CLIENT_SESSIONS.ENDPOINT IS 'The endpoint to which this session was established'
COMMENT ON COLUMN CLIENT_SESSIONS.USERIDENTIFIER IS 'uid of the client that was successfully authenticated for this session'
COMMENT ON COLUMN CLIENT_SESSIONS.DATESTART IS 'Date that specifies the time this client session started on the system'
COMMENT ON COLUMN CLIENT_SESSIONS.AUTHNMETHOD IS 'Human readable idenitifier that indicates how this user was authenticated to the system, this is a site specific attribute and should have some specific documented meaning for that site.'
COMMENT ON COLUMN CLIENT_SESSIONS.IPV4ADDRESS IS 'IPv4 address that the client authenticated from for this session'
COMMENT ON COLUMN CLIENT_SESSIONS.IPV6ADDRESS IS 'IPv6 address that the client authenticated from for this session'
COMMENT ON COLUMN CLIENT_SESSIONS.DATESTOP IS 'Date that specifies the time this client session ended on the system, this value will most likely be null for most sessions due to users closing browsers but it does record time stamps when users actually select logout'

CREATE TABLE SERVICE_POLICIES (DESCRIPTORID VARCHAR2(512) NOT NULL, LXACMLPOLICY CLOB NOT NULL, DATE_LAST_UPDATED DATE NOT NULL, PRIMARY KEY (DESCRIPTORID))
COMMENT ON TABLE SERVICE_POLICIES IS 'Stores authorative reference to all policies for all services deployed in the system'
COMMENT ON COLUMN SERVICE_POLICIES.LXACMLPOLICY IS 'Stores XML representation of LXACML authorization policy to be applied to requests at the associated service. Consumed by the ESOE PDP.'

CREATE TABLE SERVICE_POLICIES_HISTORICAL (DESCRIPTORID VARCHAR2(512) NOT NULL, LXACMLPOLICY CLOB NOT NULL, DATE_INSERTED DATE NOT NULL)
COMMENT ON TABLE SERVICE_POLICIES IS 'Stores authorative reference to all policies for all services deployed in the system'
COMMENT ON COLUMN SERVICE_POLICIES.LXACMLPOLICY IS 'Stores hitorical XML representation of LXACML authorization policy, represents value at time of creation.'

CREATE TABLE SERVICE_POLICIES_SHUNT (DESCRIPTORID VARCHAR2(512) NOT NULL, LXACMLPOLICY CLOB NOT NULL, DATE_INSERTED DATE NOT NULL, PRIMARY KEY (DESCRIPTORID))
COMMENT ON TABLE SERVICE_POLICIES IS 'Stores authorative reference to all policies for all services deployed in the system'
COMMENT ON COLUMN SERVICE_POLICIES.LXACMLPOLICY IS 'Stores held XML representation of LXACML authorization policy, represents policy that does not conform to standard and must be approved by system administrators.'

CREATE TABLE PKI_STORES (DESCRIPTORID VARCHAR2(512) NOT NULL, EXPIRYDATE DATE NOT NULL, KEYPAIRNAME VARCHAR2(255) NOT NULL UNIQUE, KEYPAIR_PASSPHRASE VARCHAR2(255) NOT NULL UNIQUE, KEYSTORE BLOB, KEYSTORE_PASSPHRASE VARCHAR2(255), PRIMARY KEY (DESCRIPTORID))
COMMENT ON TABLE PKI_STORES IS 'Stores references to all PKI keys generated in the system for use on SP''s'
COMMENT ON COLUMN PKI_STORES.DESCRIPTORID IS 'The id of the descriptor to which this PKI set belongs'
COMMENT ON COLUMN PKI_STORES.EXPIRYDATE IS 'Date that this key pair will expire so that notification may be sent to end users'
COMMENT ON COLUMN PKI_STORES.KEYPAIRNAME IS 'Identifier for the key which is specified in metadata as the ds:KeyInfo KeyName element.'
COMMENT ON COLUMN PKI_STORES.KEYPAIR_PASSPHRASE IS 'Passphrase of the generated keypair for this descriptor'
COMMENT ON COLUMN PKI_STORES.KEYSTORE IS 'generated KeyStore object'
COMMENT ON COLUMN PKI_STORES.KEYSTORE_PASSPHRASE IS 'Passphrase of generated key store'

CREATE TABLE SPEP_REGISTRATIONS (DESCRIPTORID VARCHAR2(512) NOT NULL, NODEID VARCHAR2(512) NOT NULL, IPADDRESS VARCHAR2(1024) NOT NULL, COMPILEDATE VARCHAR2(30) NOT NULL, COMPILESYSTEM VARCHAR2(512) NOT NULL, VERSION VARCHAR2(100) NOT NULL, ENVIRONMENT VARCHAR2(512) NOT NULL, DATE_ADDED DATE NOT NULL, DATE_UPDATED DATE NOT NULL, PRIMARY KEY (DESCRIPTORID, NODEID))
COMMENT ON TABLE SPEP_REGISTRATIONS IS 'Stores the current details of registered SPEPS'
COMMENT ON COLUMN SPEP_REGISTRATIONS.IPADDRESS IS 'IPAddress of the SPEP, may be space seperated for multiple addresses'
COMMENT ON COLUMN SPEP_REGISTRATIONS.COMPILEDATE IS 'Date this SPEP was compiled'
COMMENT ON COLUMN SPEP_REGISTRATIONS.COMPILESYSTEM IS 'Name of the system this SPEP was compiled on'
COMMENT ON COLUMN SPEP_REGISTRATIONS.VERSION IS 'Versioning details of the SPEP'
COMMENT ON COLUMN SPEP_REGISTRATIONS.ENVIRONMENT IS 'Environment specific details about the SPEP'
COMMENT ON COLUMN SPEP_REGISTRATIONS.DATE_ADDED IS 'Date this SPEP was first seen'
COMMENT ON COLUMN SPEP_REGISTRATIONS.DATE_UPDATED IS 'Date this SPEP was last modified'

CREATE TABLE SPEP_REGISTRATIONS_HISTORY (DESCRIPTORID VARCHAR2(512) NOT NULL, NODEID VARCHAR2(512) NOT NULL, IPADDRESS VARCHAR2(1024) NOT NULL, COMPILEDATE VARCHAR2(30) NOT NULL, COMPILESYSTEM VARCHAR2(512) NOT NULL, VERSION VARCHAR2(100) NOT NULL, ENVIRONMENT VARCHAR2(512) NOT NULL, DATE_ADDED DATE NOT NULL)
COMMENT ON TABLE SPEP_REGISTRATIONS_HISTORY IS 'Stores the current details of registered SPEPS'
COMMENT ON COLUMN SPEP_REGISTRATIONS_HISTORY.IPADDRESS IS 'IPAddress of the SPEP, may be space seperated for multiple addresses'
COMMENT ON COLUMN SPEP_REGISTRATIONS_HISTORY.COMPILEDATE IS 'Date this SPEP was compiled'
COMMENT ON COLUMN SPEP_REGISTRATIONS_HISTORY.COMPILESYSTEM IS 'Name of the system this SPEP was compiled on'
COMMENT ON COLUMN SPEP_REGISTRATIONS_HISTORY.VERSION IS 'Versioning details of the SPEP'
COMMENT ON COLUMN SPEP_REGISTRATIONS_HISTORY.ENVIRONMENT IS 'Environment specific details about the SPEP'
COMMENT ON COLUMN SPEP_REGISTRATIONS_HISTORY.DATE_ADDED IS 'Date this SPEP was first seen'

ALTER TABLE ENTITY_CONTACTS ADD CONSTRAINT FKENTITY_CON930535 FOREIGN KEY (ENTITYID) REFERENCES ENTITY_DESCRIPTORS
ALTER TABLE SERVICE_DESCRIPTIONS ADD CONSTRAINT FKSERVICE_DE602827 FOREIGN KEY (ENTITYID) REFERENCES ENTITY_DESCRIPTORS
ALTER TABLE SERVICE_ENDPOINTS  ADD CONSTRAINT FKSERVICE_EN713736 FOREIGN KEY (DESCRIPTORID) REFERENCES DESCRIPTORS
ALTER TABLE DESCRIPTORS ADD CONSTRAINT FKENTDESC FOREIGN KEY (ENTITYID) REFERENCES ENTITY_DESCRIPTORS
ALTER TABLE PKI_STORES ADD CONSTRAINT FKPKISTOR332354 FOREIGN KEY (DESCRIPTORID) REFERENCES DESCRIPTORS
ALTER TABLE SERVICE_POLICIES ADD CONSTRAINT FKSERVICE_PO306234 FOREIGN KEY (DESCRIPTORID) REFERENCES DESCRIPTORS
ALTER TABLE CLIENT_SESSIONS ADD CONSTRAINT FKCLIENT_SES105275 FOREIGN KEY (DESCRIPTORID) REFERENCES DESCRIPTORS
ALTER TABLE SPEP_REGISTRATIONS ADD CONSTRAINT FKSPEP_REGIS65644 FOREIGN KEY (DESCRIPTORID) REFERENCES DESCRIPTORS
ALTER TABLE SPEP_REGISTRATIONS_HISTORY ADD CONSTRAINT FKSPEP_REGIS647647 FOREIGN KEY (DESCRIPTORID) REFERENCES DESCRIPTORS
ALTER TABLE DESCRIPTORS ADD CONSTRAINT FKDESCTYPE FOREIGN KEY (DESCRIPTORTYPEID) REFERENCES DESCRIPTOR_TYPES
